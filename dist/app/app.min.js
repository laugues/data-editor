/*!
 * Copyright 2015 itesoft.
 * http://itesoft.com/
 *
 * ML Editor, v0.0.0
 *Itesoft ML Editor App.*/
!function(){"use strict";angular.module("MLEditor",["itesoft","ngRoute","pascalprecht.translate","ui.codemirror","ui.grid.infiniteScroll","base64"]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]).run(["$http","$translate",function(e,t){e.defaults.headers.common.Authorization="",t.refresh(),t.use("fr")}]).run(["$rootScope","$route",function(e,t){e.$on("$routeChangeSuccess",function(){e.pageTitle=t.current.title})}]),angular.module("MLEditor").constant("globalConstants",{DATA_SERVER_CONNECTION:"http://CLILDS",DATA_DATABASE_NAME:"das-db",LOGIN_PATH:"/das-db/rest/db/storedXqueries/login.xqy",INVOICE:{SEARCH:{PATH:"/das-db/rest/db/storedXqueries/search-invoice.xqy?mode=json",RESULT_MAX_NUMBER:"50"},GET:{PATH:"/das-db/rest/db/storedXqueries/get-invoice.xqy"},SAVE:{PATH:"/das-db/rest/db/storedXqueries/importFile.xqy"},DELETE:{PATH:"/das-db/rest/db/storedXqueries/delete-invoice.xqy"}},INVOICE_QUEUED:{SEARCH:{PATH:"/das-db/rest/db/storedXqueries/queue/search-queued-invoice-light.xqy?mode=json",RESULT_MAX_NUMBER:"50"},GET:{PATH:"/das-db/rest/db/storedXqueries/files/get-file.xqy"},GET_LIGHT:{PATH:"/das-db/rest/db/storedXqueries/queue/get-queued-invoice-light.xqy"},SAVE:{PATH:"/das-db/rest/db/storedXqueries/importFile.xqy"},DELETE:{PATH:"/das-db/rest/db/storedXqueries/queue/delete-queued-invoice.xqy"}},CONFIGURATION_FILES:{GET:{PATH:"/das-db/rest/db/storedXqueries/files/get-file.xqy"},SAVE:{PATH:"/das-db/rest/db/storedXqueries/importFile.xqy"},SEARCH:{PATH:"/das-db/rest/db/storedXqueries/files/get-editable-files.xqy"}}}),angular.module("MLEditor").config(["$routeProvider",function(e){e.when("/login",{templateUrl:"app/features/login/loginView.html",controller:"LoginController"}).when("/logout",{templateUrl:"app/features/login/loginView.html",controller:"LogoutController",redirectTo:"/login"}).when("/invoices/search",{templateUrl:"app/features/invoices/search/invoice-search.html",controller:"InvoiceSearchController",title:"PAGE.INVOICE_TITLE"}).when("/invoices/queued",{templateUrl:"app/features/invoices/queued/invoice-queued.html",controller:"InvoiceQueuedController",title:"PAGE.INVOICE_QUEUED_TITLE"}).when("/configuration/files",{templateUrl:"app/features/configuration/files/configurarionFilesView.html",controller:"ConfigurationFilesController",title:"PAGE.CONFIGURATION_FILE_TITLE"}).otherwise({redirectTo:"/login"})}]),angular.module("MLEditor").config(["$translateProvider","$translatePartialLoaderProvider",function(e,t){e.registerAvailableLanguageKeys(["en","fr"],{en_US:"en",en_GB:"en",fr_FR:"fr","fr-CA":"fr"}).determinePreferredLanguage(),e.useLoader("$translatePartialLoader",{urlTemplate:"assets/locale/{lang}/{part}-{lang}.json"}),t.addPart("global")}]),angular.module("MLEditor").factory("AuthenticationInterceptor",["$rootScope","$q","$location",function(e,t,n){var r={request:function(t){return"undefined"!=typeof e.basicAuthenticationValue&&null!=e.basicAuthenticationValue&&""!=e.basicAuthenticationValue&&"undefined"!=typeof e.isAuthenticated&&e.isAuthenticated||n.path("/login"),t},response:function(e){return e}};return r}]),angular.module("MLEditor").factory("RequestService",["$http","globalConstants","$rootScope",function(e,t,n){function r(t,r){return e({method:"GET",url:t,headers:o(n.basicAuthenticationValue),params:r})}function a(t,r,a){return e({method:"POST",url:t,data:r,headers:o(n.basicAuthenticationValue),params:a})}function i(e){return t.DATA_SERVER_CONNECTION+e}function o(e){var t={};return"undefined"!=typeof e&&""!=e&&(t.Authorization=e),t.Pragma="no-cache",t["Cache-Control"]="no-cache, no-store, must-revalidate",t}var l={doPost:a,doGet:r,buildServiceUrl:i};return l}]),angular.module("MLEditor").controller("MainController",["$scope","$translate",function(e,t){e.currentLanguage="fr_FR",e.editorOptions={lineWrapping:!0,lineNumbers:!0,indentWithTabs:!0,matchTags:{bothTags:!0},extraKeys:{"Ctrl-J":"toMatchingTag",F11:function(t){t.setOption("fullScreen",!t.getOption("fullScreen")),e.isFullScreen=!0},Esc:function(t){t.getOption("fullScreen")&&t.setOption("fullScreen",!1),e.isFullScreen=!1},"Ctrl-Q":function(e){e.foldCode(e.getCursor())}},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],styleActiveLine:!0,mode:"xml"},e.changeLanguage=function(n){e.currentLanguage=n,t.use(n)}}]),angular.module("MLEditor").controller("LoginController",["$base64","$scope","$rootScope","$location","LoginService",function(e,t,n,r,a){function i(){return t.basicEncrypted=e.encode(t.account.user+":"+t.account.password),"Basic "+t.basicEncrypted}t.loginFailed=!1,t.login=function(){n.basicAuthenticationValue=i(),a.connect().then(function(e){t.status=e.status,n.isAuthenticated=!0,r.path("/invoices/search")},function(e){n.isAuthenticated=!1,t.loginFailed=!0})}}]),angular.module("MLEditor").controller("LogoutController",["LoginService",function(e){e.logout()}]),angular.module("MLEditor").factory("LoginService",["$rootScope","globalConstants","RequestService",function(e,t,n){function r(){var e=n.buildServiceUrl(t.LOGIN_PATH);return n.doGet(e,{})}function a(){e.basicAuthenticationValue=null,e.isAuthenticated=!1,e.loginFailed=!1}var i={connect:r,logout:a};return i}]),angular.module("MLEditor").controller("ConfigurationFilesController",["$scope","globalConstants","itPopup","ConfigurationFilesService","$translate","$window",function(e,t,n,r,a,i){function o(e){var t=null;return null!=e&&(t=e.path),t}function l(){var t=e.masterDetails.getCurrentItemWrapper().originalItem;return o(t)}function s(t){var n="",r=d(t);return"undefined"!=typeof r&&""!=r&&null!=r?(e.errorStatusCode={value:c(t)},e.errorStatus={value:f(t)},e.errorMessageCode={value:m(t)},e.errorMessage={value:p(t)},n=a.instant("ERROR_CODE",e.errorStatusCode)+" </br>"+a.instant("ERROR_STATE",e.errorStatus)+" </br>"+a.instant("ERROR_MESSAGE_CODE",e.errorMessageCode)+" </br>"+a.instant("ERROR_MESSAGE",e.errorMessage)+" </br>"):n=u(t),n}function u(e){return e.data}function d(e){return e.data.errorResponse}function c(e){return d(e).statusCode}function c(e){return d(e).statusCode}function f(e){return d(e).status}function m(e){return d(e).messageCode}function p(e){return d(e).message}function I(t){var n=new DOMParser,r=null;try{r=n.parseFromString(t,"text/xml"),e.currentXmlDOM=r}catch(a){return console.error("Xml is not valid : ",a.message),!1}return!0}e.lastItemIdentifier=null,e.currentXmlDOM=null,e.masterDetails={},e.files=[{name:"indicators.xml",path:"/db/models/indicators.xml"},{name:"flow-indicators.xml",path:"/db/models/flow-indicators.xml"}],e.masterDetails={columnDefs:[{field:"name",displayName:"CONFIGURATION.FILE.NAME",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"path",displayName:"CONFIGURATION.FILE.PATH",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1}]},e.masterDetails.disableMultiSelect=!0,e.masterDetails.navAlert={text:"{{'CANNOT_EDIT_INVOCIE' | translate}}",title:"{{'WARNING' | translate}}"},e.deleteIsDisabled=function(){var t=!1;return 0==e.masterDetail.getSelectedItems().length&&(t=!0),t},e.$watch("masterDetails.getCurrentItemWrapper().originalItem",function(){if(e.itemIdentifier=null,null!=e.masterDetails.getCurrentItemWrapper()&&"undefined"!=typeof e.masterDetails.getCurrentItemWrapper()){var t=l();null!=t&&(e.itemIdentifier=t)}"undefined"!=typeof e.itemIdentifier&&null!=e.itemIdentifier&&e.itemIdentifier!==e.lastItemIdentifier&&r.get(e.itemIdentifier,"xml").then(function(t){e.loadXmlInCurrentItem(t),e.$applyAsync(function(){e.masterDetails.setCurrentItem(e.files[e.masterDetails.getCurrentItemWrapper().index])}),e.lastItemIdentifier=e.itemIdentifier},function(t){e.data=t.data||"Request failed",e.status=t.status})}),e.loadXmlInCurrentItem=function(t){var n={};angular.copy(e.files[e.masterDetails.getCurrentItemWrapper().index],n),n.xml=vkbeautify.xml(t.data),angular.copy(n,e.files[e.masterDetails.getCurrentItemWrapper().index])},e.getDetailMessage=function(){var t="";return e.masterDetails.initState&&(t=e.masterDetails.getSelectedItems().length>0?e.masterDetails.getSelectedItems().length+" items selected":a.instant("NO_ITEM_SELECTED")),t},e.reloadFiles=function(){e.search()},e.search=function(){r.search("json").then(function(t){"undefined"!=typeof t.data.files&&(e.files=t.data.files.file,e.$applyAsync(function(){var e=document.createEvent("Event");e.initEvent("resize",!0,!0),i.dispatchEvent(e)}))},function(t){e.data=t.data||"Request failed",e.status=t.status;var n=s(t);e.showAlertPopup("SAVE_FAILED",n)})},e.showAlertPopup=function(e,t){n.alert({title:a.instant(e),text:t})},e.save=function(){var t=I(e.masterDetails.getCurrentItemWrapper().currentItem.xml);return t?void r.save("CONF",e.masterDetails.getCurrentItemWrapper().currentItem.xml,e.itemIdentifier).then(function(t){angular.copy(e.masterDetails.getCurrentItemWrapper().currentItem,e.files[e.masterDetails.getCurrentItemWrapper().index]);var n=t.data;e.showAlertPopup("SAVE_RESULT",n),e.$broadcast("unlockCurrentItem")},function(t){e.data=t.data||"Request failed",e.status=t.status;var n=s(t);e.showAlertPopup("SAVE_FAILED",n)}):void e.showAlertPopup("ERROR","{{'XML_NOT_VALID' | translate}}")},e.undoChange=function(){e.masterDetails.undoChangeCurrentItem(),e.disableSaveActions=!1},e.files=e.search()}]),angular.module("MLEditor").factory("ConfigurationFilesService",["globalConstants","RequestService",function(e,t){function n(n){var r=t.buildServiceUrl(e.CONFIGURATION_FILES.SEARCH.PATH),a=l(e.DATA_DATABASE_NAME,n);return t.doGet(r,a)}function r(n,r,a){var i=t.buildServiceUrl(e.CONFIGURATION_FILES.SAVE.PATH),l=o(n,a);return t.doPost(i,r,l)}function a(n,r){var a=t.buildServiceUrl(e.CONFIGURATION_FILES.GET.PATH),o=i(n,r);return t.doGet(a,o)}function i(e,t){var n={};return n.uri=s(e).uri,n.mode=u(t).mode,n}function o(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n.type=e),"undefined"!=typeof t&&""!=t&&(n.uri=t),n}function l(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n["db-name"]=e),n.mode=u(t).mode,n}function s(e){var t={};return t.uri="","undefined"!=typeof e&&""!=e&&(t.uri=e),t}function u(e){var t={};return t.mode="","undefined"!=typeof e&&""!=e&&(t.mode=e),t}var d={search:n,save:r,get:a};return d}]),angular.module("MLEditor").controller("InvoiceQueuedController",["$scope","globalConstants","itPopup","InvoiceQueuedService","$translate","$window",function(e,t,n,r,a,i){function o(e){var t=null;return null!=e&&null!=e.uri&&(t=e.uri),t}function l(){var t=e.masterDetails.getCurrentItemWrapper().originalItem;return o(t)}function s(t){var n=new DOMParser,r=null;try{r=n.parseFromString(t,"text/xml"),e.invoiceXmlDOM=r}catch(a){return console.error("Xml is not valid : ",a.message),!1}return!0}function u(){var t=null;if("undefined"!=typeof e.invoiceXmlDOM&&null!=e.invoiceXmlDOM){var n=e.invoiceXmlDOM.getElementsByTagName("ItesoftId");if(null!=n&&"undefined"!=typeof n&&n.length>0)if(null!=n[0]&&"undefined"!=typeof n[0].innerHTML&&""!==n[0].innerHTML)t=n[0].innerHTML;else{var r=n[0].childNodes;r.length>0&&null!=r[0]&&"undefined"!=typeof r[0]?t=r[0].nodeValue:console.error("Itesoft id from xml is null or empty")}else console.error("Cannot find 'ItesoftId' element in invoice xml")}else console.error("$scope.invoiceXmlDOM is undefined or null. So cannot retrieve 'ItesoftId' element in xml.");return t}function u(){var t=null;if("undefined"!=typeof e.invoiceXmlDOM&&null!=e.invoiceXmlDOM){var n=e.invoiceXmlDOM.getElementsByTagName("ItesoftId");if(null!=n&&"undefined"!=typeof n&&n.length>0)if(null!=n[0]&&"undefined"!=typeof n[0].innerHTML&&""!==n[0].innerHTML)t=n[0].innerHTML;else{var r=n[0].childNodes;r.length>0&&null!=r[0]&&"undefined"!=typeof r[0]?t=r[0].nodeValue:console.error("Itesoft id from xml is null or empty")}else console.error("Cannot find 'ItesoftId' element in invoice xml")}else console.error("$scope.invoiceXmlDOM is undefined or null. So cannot retrieve 'ItesoftId' element in xml.");return t}function d(t){var n="",r=m(t);return"undefined"!=typeof r&&""!=r&&null!=r?(e.errorStatusCode={value:p(t)},e.errorStatus={value:I(t)},e.errorMessageCode={value:g(t)},e.errorMessage={value:v(t)},n=a.instant("ERROR_CODE",e.errorStatusCode)+" </br>"+a.instant("ERROR_STATE",e.errorStatus)+" </br>"+a.instant("ERROR_MESSAGE_CODE",e.errorMessageCode)+" </br>"+a.instant("ERROR_MESSAGE",e.errorMessage)+" </br>"):n=f(t),n}function c(e){var t=f(e);return t}function f(e){return e.data}function m(e){return e.data.errorResponse}function p(e){return m(e).statusCode}function p(e){return m(e).statusCode}function I(e){return m(e).status}function g(e){return m(e).messageCode}function v(e){return m(e).message}function E(t){var n={};n=t.data.queuedInvoice,e.$applyAsync(function(){n.xml=e.masterDetails.getCurrentItemWrapper().currentItem.xml,angular.copy(n,e.invoices[e.masterDetails.getCurrentItemWrapper().index])})}function C(t,n){angular.forEach(t,function(t){var r=n.indexOf(t);e.sendDeleteRequest(o(t),n,r)})}function D(e,t){e.splice(t,1)}e.lastItemIdentifier=null,e.invoiceXmlDOM=null,e.masterDetails={},e.invoices=[],e.masterDetails={columnDefs:[{field:"range",displayName:"UPDATE_RANGE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"itesoftId",displayName:"ITESOFT_ID",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"businessGroup",displayName:"BUSINNESS_GROUP",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"batchName",displayName:"BATCH_NAME",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!1},{field:"scanDate",displayName:"SCAN_DATE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0}]},e.masterDetails.disableMultiSelect=!0,e.masterDetails.navAlert={text:"{{'CANNOT_EDIT_INVOCIE' | translate}}",title:"{{'WARNING' | translate}}"},e.clearCriteria=function(){e.search.itesoftid="",e.search.batchname="",e.search.businessgroup="",e.search.state="",e.search.invoicenumber="",e.search.category="",e.search.startDate="",e.search.endDate=""},e.deleteIsDisabled=function(){var t=!1;return 0==e.masterDetail.getSelectedItems().length&&(t=!0),t},e.$watch("masterDetails.getCurrentItemWrapper().originalItem",function(){if(e.itemIdentifier=null,null!=e.masterDetails.getCurrentItemWrapper()&&"undefined"!=typeof e.masterDetails.getCurrentItemWrapper()){var t=l();null!=t&&(e.itemIdentifier=t)}"undefined"!=typeof e.itemIdentifier&&null!=e.itemIdentifier&&e.itemIdentifier!==e.lastItemIdentifier&&r.get(e.itemIdentifier,"xml").then(function(t){e.loadXmlInCurrentItem(t),e.$applyAsync(function(){e.masterDetails.setCurrentItem(e.invoices[e.masterDetails.getCurrentItemWrapper().index])}),e.lastItemIdentifier=e.itemIdentifier},function(t){e.data=t.data||"Request failed",e.status=t.status})}),e.loadXmlInCurrentItem=function(t){var n={};angular.copy(e.invoices[e.masterDetails.getCurrentItemWrapper().index],n),n.xml=vkbeautify.xml(t.data),angular.copy(n,e.invoices[e.masterDetails.getCurrentItemWrapper().index])},e.getDetailMessage=function(){var t="";return e.masterDetails.initState&&(t=e.masterDetails.getSelectedItems().length>0?e.masterDetails.getSelectedItems().length+" items selected":a.instant("NO_ITEM_SELECTED")),t},e.search=function(){e.invoices=[],r.search(e.search).then(function(t){e.status=t.status,"undefined"!=typeof t.data.result.queuedInvoice&&(e.invoices=t.data.result.queuedInvoice,e.total=t.data.result.total,e.pageStart=t.data.result.pageStart,e.pageNum=t.data.result.pageNum,e.$applyAsync(function(){var e=document.createEvent("Event");e.initEvent("resize",!0,!0),i.dispatchEvent(e)}))},function(t){e.data=t.data||"Request failed",e.status=t.status;var n=d(t);e.showAlertPopup("SEARCH_FAILED",n)})},e.showAlertPopup=function(e,t){n.alert({title:a.instant(e),text:t})},e.showConfirmPopupDeleteItems=function(t,r){var a=n.confirm({title:t,text:r,buttons:[{text:"{{'CONFIRM_BUTTON' | translate}}",type:"btn-danger",onTap:function(){return!0}},{text:"{{'CANCEL_BUTTON' | translate}}",type:"btn-success",onTap:function(){return!1}}]});a.then(function(t){C(e.masterDetails.getSelectedItems(),e.invoices),e.masterDetails.setCurrentItem(null)},function(){})},e.save=function(){var t=s(e.masterDetails.getCurrentItemWrapper().currentItem.xml);return t?(("undefined"==typeof e.itemIdentifier||null==e.itemIdentifier)&&(e.itemIdentifier=u(),console.log("$scope.itemIdentifier after set = ",e.itemIdentifier)),console.log("$scope.itemIdentifier = ",e.itemIdentifier),void r.save("QUEUE",e.masterDetails.getCurrentItemWrapper().currentItem.xml,e.itemIdentifier).then(function(t){angular.copy(e.masterDetails.getCurrentItemWrapper().currentItem,e.invoices[e.masterDetails.getCurrentItemWrapper().index]);var n=c(t);e.showAlertPopup("SAVE_RESULT",n),r.getLight(e.itemIdentifier,"json").then(function(e){E(e)},function(t){e.data=t.data||"Request failed",e.status=t.status}),e.$broadcast("unlockCurrentItem")},function(t){e.data=t.data||"Request failed",e.status=t.status;var n=d(t);e.showAlertPopup("SAVE_FAILED",n)})):void e.showAlertPopup("ERROR","{{'XML_NOT_VALID' | translate}}")},e.undoChange=function(){var t=!1,n=e.masterDetails.getCurrentItemWrapper();if(null!=n&&"undefined"!=typeof n){var r=n.originalItem;if(null==r||"undefined"==typeof r||null==r.xml||""==r.xml){var a=e.masterDetails.getCurrentItemWrapper().currentItem;if(null!=a&&(null==a.xml||""==a.xml)&&e.invoices.length>0){D(e.invoices,e.invoices.length-1);var t=!0}}}e.masterDetails.undoChangeCurrentItem(),t&&e.masterDetails.setCurrentItem(null),e.disableSaveActions=!1},e.addNewItem=function(){var t={xml:null};e.invoices.push(t),e.masterDetails.setCurrentItem(t).then(function(t){e.$broadcast("lockCurrentItem",!1)},function(e){})},e.deleteSelectedItems=function(){e.showConfirmPopupDeleteItems("{{'DELETE_POPUP_TITLE' | translate}}","{{'DELETE_POPUP_TEXT' | translate}}")},e.sendDeleteRequest=function(t,n,a){r["delete"](t).then(function(t){var r=c(t);e.showAlertPopup("DELETE_RESULT",r),e.$broadcast("unlockCurrentItem"),D(n,a)},function(t){var n=d(t);e.showAlertPopup("DELETE_FAILED",n)})}}]),angular.module("MLEditor").factory("InvoiceQueuedService",["globalConstants","RequestService",function(e,t){function n(n){var r=t.buildServiceUrl(e.INVOICE_QUEUED.SEARCH.PATH),a=c(n);return t.doGet(r,a)}function r(n,r,a){var i=t.buildServiceUrl(e.INVOICE_QUEUED.SAVE.PATH),o=d(n,a);return t.doPost(i,r,o)}function a(n){var r=t.buildServiceUrl(e.INVOICE_QUEUED.DELETE.PATH),a=s(n);return t.doGet(r,a)}function i(n,r){var a=t.buildServiceUrl(e.INVOICE_QUEUED.GET.PATH),i=l(n,r);return t.doGet(a,i)}function o(n,r){var a=t.buildServiceUrl(e.INVOICE_QUEUED.GET_LIGHT.PATH),i=l(n,r);return t.doGet(a,i)}function l(e,t){var n={};return n.uri=s(e).uri,n.mode=u(t).mode,n}function s(e){var t={};return t.itesoftid="","undefined"!=typeof e&&""!=e&&(t.uri=e),t}function u(e){var t={};return t.mode="","undefined"!=typeof e&&""!=e&&(t.mode=e),t}function d(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n.type=e),"undefined"!=typeof t&&""!=t&&(n.uri=t),n}function c(t){var n={};return"undefined"!=typeof t.itesoftid&&""!=t.itesoftid&&(n.itesoftid=t.itesoftid),"undefined"!=typeof t.batchname&&""!=t.batchname&&(n.batchname=t.batchname),"undefined"!=typeof t.businessgroup&&""!=t.businessgroup&&(n.businessgroup=t.businessgroup),"undefined"!=typeof t.state&&""!=t.state&&(n.state=t.state),"undefined"!=typeof t.invoicenumber&&""!=t.invoicenumber&&(n.invoicenumber=t.invoicenumber),"undefined"!=typeof t.category&&""!=t.category&&(n.category=t.category),"undefined"!=typeof t.startDate&&""!=t.startDate&&(n.startDate=t.startDate),"undefined"!=typeof t.endDate&&""!=t.endDate&&(n.endDate=t.endDate),n.mode=t.mode,n.pageNum=e.INVOICE_QUEUED.SEARCH.RESULT_MAX_NUMBER,n}var f={search:n,save:r,get:i,getLight:o,"delete":a};return f}]),angular.module("MLEditor").controller("InvoiceSearchController",["$scope","globalConstants","itPopup","InvoiceService","$translate","$window",function(e,t,n,r,a,i){function o(e){var t=null;return null!=e&&null!=e.ItesoftData&&null!=e.ItesoftData.Document&&null!=e.ItesoftData.Document.Class&&null!=e.ItesoftData.Document.Class.ITESOFTFields&&null!=e.ItesoftData.Document.Class.ITESOFTFields.ItesoftId&&(t=e.ItesoftData.Document.Class.ITESOFTFields.ItesoftId),t}function l(){var t=e.masterDetails.getCurrentItemWrapper().originalItem;return o(t)}function s(t){var n=new DOMParser,r=null;try{r=n.parseFromString(t,"text/xml"),e.invoiceXmlDOM=r}catch(a){return console.error("Xml is not valid : ",a.message),!1}return!0}function u(){var t=null;if("undefined"!=typeof e.invoiceXmlDOM&&null!=e.invoiceXmlDOM){var n=e.invoiceXmlDOM.getElementsByTagName("ItesoftId");if(null!=n&&"undefined"!=typeof n&&n.length>0)if(null!=n[0]&&"undefined"!=typeof n[0].innerHTML&&""!==n[0].innerHTML)t=n[0].innerHTML;else{var r=n[0].childNodes;r.length>0&&null!=r[0]&&"undefined"!=typeof r[0]?t=r[0].nodeValue:console.error("Itesoft id from xml is null or empty")}else console.error("Cannot find 'ItesoftId' element in invoice xml")}else console.error("$scope.invoiceXmlDOM is undefined or null. So cannot retrieve 'ItesoftId' element in xml.");return t}function d(t){var n="",r=m(t);return"undefined"!=typeof r&&""!=r&&null!=r?(e.errorStatusCode={value:p(t)},e.errorStatus={value:I(t)},e.errorMessageCode={value:g(t)},e.errorMessage={value:v(t)},n=a.instant("ERROR_CODE",e.errorStatusCode)+" </br>"+a.instant("ERROR_STATE",e.errorStatus)+" </br>"+a.instant("ERROR_MESSAGE_CODE",e.errorMessageCode)+" </br>"+a.instant("ERROR_MESSAGE",e.errorMessage)+" </br>"):n=f(t),n}function c(e){var t=f(e);return t}function f(e){return e.data}function m(e){return e.data.errorResponse}function p(e){return m(e).statusCode}function p(e){return m(e).statusCode}function I(e){return m(e).status}function g(e){return m(e).messageCode}function v(e){return m(e).message}function E(t){var n={};n=t.data,e.$applyAsync(function(){n.xml=e.masterDetails.getCurrentItemWrapper().currentItem.xml,angular.copy(n,e.invoices[e.masterDetails.getCurrentItemWrapper().index])})}function C(t,n){angular.forEach(t,function(t){var r=n.indexOf(t);e.sendDeleteRequest(o(t),n,r)})}function D(e,t){e.splice(t,1)}e.lastItesoftId=null,e.invoiceXmlDOM=null,e.masterDetails={},e.invoices=[],e.masterDetails={columnDefs:[{field:"ItesoftData.Document.Class.ITESOFTFields.ItesoftId",displayName:"ITESOFT_ID",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"ItesoftData.Document.Class.ITESOFTFields.BusinessGroup",displayName:"BUSINNESS_GROUP",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"ItesoftData.Document.Class.HeaderFields.BATCHNAME",displayName:"BATCH_NAME",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!1},{field:"ItesoftData.Document.Class.HeaderFields.STATE",displayName:"STATE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0},{field:"ItesoftData.Document.Class.HeaderFields.SCANDATE",displayName:"SCAN_DATE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0}]},e.masterDetails.disableMultiSelect=!0,e.masterDetails.navAlert={text:"{{'CANNOT_EDIT_INVOCIE' | translate}}",title:"{{'WARNING' | translate}}"},e.clearCriteria=function(){e.search.itesoftid="",e.search.batchname="",e.search.businessgroup="",e.search.state="",e.search.invoicenumber="",e.search.category="",e.search.startDate="",e.search.endDate=""},e.deleteIsDisabled=function(){var t=!1;return 0==e.masterDetail.getSelectedItems().length&&(t=!0),t},e.$watch("masterDetails.getCurrentItemWrapper().originalItem",function(){if(e.invoiceId=null,null!=e.masterDetails.getCurrentItemWrapper()&&"undefined"!=typeof e.masterDetails.getCurrentItemWrapper()){var t=l();null!=t&&(e.invoiceId=t)}"undefined"!=typeof e.invoiceId&&null!=e.invoiceId&&e.invoiceId!==e.lastItesoftId&&r.get(e.invoiceId,"xml").then(function(t){e.loadXmlInCurrentItem(t),e.$applyAsync(function(){e.masterDetails.setCurrentItem(e.invoices[e.masterDetails.getCurrentItemWrapper().index])}),e.lastItesoftId=e.invoiceId},function(t){e.data=t.data||"Request failed",e.status=t.status})}),e.loadXmlInCurrentItem=function(t){var n={};angular.copy(e.invoices[e.masterDetails.getCurrentItemWrapper().index],n),n.xml=vkbeautify.xml(t.data),angular.copy(n,e.invoices[e.masterDetails.getCurrentItemWrapper().index])},e.getDetailMessage=function(){var t="";return e.masterDetails.initState&&(t=e.masterDetails.getSelectedItems().length>0?e.masterDetails.getSelectedItems().length+" items selected":a.instant("NO_ITEM_SELECTED")),t},e.search=function(){e.invoices=[],r.search(e.search).then(function(t){e.status=t.status,"undefined"!=typeof t.data.invoice&&(e.invoices=t.data.invoice,e.$applyAsync(function(){var e=document.createEvent("Event");e.initEvent("resize",!0,!0),i.dispatchEvent(e),console.log("resize event...")}))},function(t){e.data=t.data||"Request failed",e.status=t.status;var n=d(t);e.showAlertPopup("SEARCH_FAILED",n)})},e.showAlertPopup=function(e,t){n.alert({title:a.instant(e),text:t})},e.showConfirmPopupDeleteItems=function(t,r){var a=n.confirm({title:t,text:r,buttons:[{text:"{{'CONFIRM_BUTTON' | translate}}",type:"btn-danger",onTap:function(){return!0}},{text:"{{'CANCEL_BUTTON' | translate}}",type:"btn-success",onTap:function(){return!1}}]});a.then(function(t){C(e.masterDetails.getSelectedItems(),e.invoices),e.masterDetails.setCurrentItem(null)},function(){})},e.save=function(){var t=s(e.masterDetails.getCurrentItemWrapper().currentItem.xml);return t?void r.save("INVOICE",e.masterDetails.getCurrentItemWrapper().currentItem.xml,"/db/invoices/2002/01/01/TEST/INV_20020101_TEST.xml").then(function(t){angular.copy(e.masterDetails.getCurrentItemWrapper().currentItem,e.invoices[e.masterDetails.getCurrentItemWrapper().index]);var n=c(t);e.showAlertPopup("SAVE_RESULT",n),e.invoiceId=u(),r.get(e.invoiceId,"json").then(function(e){E(e)},function(t){e.data=t.data||"Request failed",e.status=t.status}),e.$broadcast("unlockCurrentItem")},function(t){e.data=t.data||"Request failed",e.status=t.status;var n=d(t);e.showAlertPopup("SAVE_FAILED",n)}):void e.showAlertPopup("ERROR","{{'XML_NOT_VALID' | translate}}")},e.undoChange=function(){var t=!1,n=e.masterDetails.getCurrentItemWrapper();if(null!=n&&"undefined"!=typeof n){var r=n.originalItem;if(null==r||"undefined"==typeof r||null==r.xml||""==r.xml){var a=e.masterDetails.getCurrentItemWrapper().currentItem;if(null!=a&&(null==a.xml||""==a.xml)&&e.invoices.length>0){D(e.invoices,e.invoices.length-1);var t=!0}}}e.masterDetails.undoChangeCurrentItem(),t&&e.masterDetails.setCurrentItem(null),e.disableSaveActions=!1},e.addNewItem=function(){var t={xml:null};e.invoices.push(t),e.masterDetails.setCurrentItem(t).then(function(t){e.$broadcast("lockCurrentItem",!1)},function(e){})},e.deleteSelectedItems=function(){e.showConfirmPopupDeleteItems("{{'DELETE_POPUP_TITLE' | translate}}","{{'DELETE_POPUP_TEXT' | translate}}")},e.sendDeleteRequest=function(t,n,a){r["delete"](t).then(function(t){var r=c(t);e.showAlertPopup("DELETE_RESULT",r),e.$broadcast("unlockCurrentItem"),D(n,a)},function(t){var n=d(t);e.showAlertPopup("DELETE_FAILED",n)})}}]),angular.module("MLEditor").factory("InvoiceService",["globalConstants","RequestService",function(e,t){function n(n){var r=t.buildServiceUrl(e.INVOICE.SEARCH.PATH),a=d(n);return t.doGet(r,a)}function r(n,r,a){var i=t.buildServiceUrl(e.INVOICE.SAVE.PATH),o=u(n,a);return t.doPost(i,r,o)}function a(n){var r=t.buildServiceUrl(e.INVOICE.DELETE.PATH),a=l(n);return t.doGet(r,a)}function i(n,r){var a=t.buildServiceUrl(e.INVOICE.GET.PATH),i=o(n,r);return t.doGet(a,i)}function o(e,t){var n={};return n.itesoftid=l(e).itesoftid,n.mode=s(t).mode,n}function l(e){var t={};return t.itesoftid="","undefined"!=typeof e&&""!=e&&(t.itesoftid=e),t}function s(e){var t={};return t.mode="","undefined"!=typeof e&&""!=e&&(t.mode=e),t}function u(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n.type=e),"undefined"!=typeof t&&""!=t&&(n.uri=t),n}function d(t){var n={};return"undefined"!=typeof t.itesoftid&&""!=t.itesoftid&&(n.itesoftid=t.itesoftid),"undefined"!=typeof t.batchname&&""!=t.batchname&&(n.batchname=t.batchname),"undefined"!=typeof t.businessgroup&&""!=t.businessgroup&&(n.businessgroup=t.businessgroup),"undefined"!=typeof t.state&&""!=t.state&&(n.state=t.state),"undefined"!=typeof t.invoicenumber&&""!=t.invoicenumber&&(n.invoicenumber=t.invoicenumber),"undefined"!=typeof t.category&&""!=t.category&&(n.category=t.category),"undefined"!=typeof t.startDate&&""!=t.startDate&&(n.startDate=t.startDate),"undefined"!=typeof t.endDate&&""!=t.endDate&&(n.endDate=t.endDate),n.mode=t.mode,n.pageNum=e.INVOICE.SEARCH.RESULT_MAX_NUMBER,n}var c={search:n,save:r,get:i,"delete":a};return c}])}();