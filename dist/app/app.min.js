/*!
 * Copyright 2015 itesoft.
 * http://itesoft.com/
 *
 * Documents Editor, v0.0.0
 *Itesoft Documents Editor App.*/
!function(){"use strict";angular.module("MLEditor",["itesoft","ngRoute","pascalprecht.translate","ui.codemirror","ui.grid.infiniteScroll","base64"]).config(["$httpProvider",function(e){e.interceptors.push("AuthenticationInterceptor")}]).run(["$http","$translate",function(e,t){e.defaults.headers.common.Authorization="",t.refresh(),t.use("fr")}]).run(["$rootScope","$route",function(e,t){e.$on("$routeChangeSuccess",function(){e.pageTitle=t.current.title})}]),angular.module("MLEditor").constant("globalConstants",{DATA_DATABASE_NAME:"das-db",LOGIN_PATH:"/das-db/rest/db/storedXqueries/login.xqy",INVOICE:{SEARCH:{PATH:"/das-db/rest/db/storedXqueries/search-invoice.xqy?mode=json",RESULT_MAX_NUMBER:"50"},GET:{PATH:"/das-db/rest/db/storedXqueries/get-invoice.xqy"},SAVE:{PATH:"/das-db/rest/db/storedXqueries/importFile.xqy"},DELETE:{PATH:"/das-db/rest/db/storedXqueries/delete-invoice.xqy"}},INVOICE_QUEUED:{SEARCH:{PATH:"/das-db/rest/db/storedXqueries/queue/search-queued-invoice-light.xqy?mode=json",RESULT_MAX_NUMBER:"50"},GET:{PATH:"/das-db/rest/db/storedXqueries/files/get-file.xqy"},GET_LIGHT:{PATH:"/das-db/rest/db/storedXqueries/queue/get-queued-invoice-light.xqy"},SAVE:{PATH:"/das-db/rest/db/storedXqueries/importFile.xqy"},DELETE:{PATH:"/das-db/rest/db/storedXqueries/queue/delete-queued-invoice.xqy"}},CONFIGURATION_FILES:{GET:{PATH:"/das-db/rest/db/storedXqueries/files/get-file.xqy"},SAVE:{PATH:"/das-db/rest/db/storedXqueries/importFile.xqy"},SEARCH:{PATH:"/das-db/rest/db/storedXqueries/files/get-editable-files.xqy"}}}),angular.module("MLEditor").config(["$routeProvider",function(e){e.when("/login",{templateUrl:"app/features/login/loginView.html",controller:"LoginController"}).when("/logout",{templateUrl:"app/features/login/loginView.html",controller:"LogoutController",redirectTo:"/login"}).when("/invoices/search",{templateUrl:"app/features/invoices/search/invoice-search.html",controller:"InvoiceSearchController",title:"PAGE.INVOICE_TITLE"}).when("/invoices/queued",{templateUrl:"app/features/invoices/queued/invoice-queued.html",controller:"InvoiceQueuedController",title:"PAGE.INVOICE_QUEUED_TITLE"}).when("/configuration/files",{templateUrl:"app/features/configuration/files/configurarionFilesView.html",controller:"ConfigurationFilesController",title:"PAGE.CONFIGURATION_FILE_TITLE"}).otherwise({redirectTo:"/login"})}]),angular.module("MLEditor").config(["$translateProvider","$translatePartialLoaderProvider",function(e,t){e.registerAvailableLanguageKeys(["en","fr"],{en_US:"en",en_GB:"en",fr_FR:"fr","fr-CA":"fr"}).determinePreferredLanguage(),e.useLoader("$translatePartialLoader",{urlTemplate:"assets/locale/{lang}/{part}-{lang}.json"}),t.addPart("global")}]),angular.module("MLEditor").factory("AuthenticationInterceptor",["$rootScope","$q","$location",function(e,t,n){var r={request:function(t){return"undefined"!=typeof e.basicAuthenticationValue&&null!=e.basicAuthenticationValue&&""!=e.basicAuthenticationValue&&"undefined"!=typeof e.isAuthenticated&&e.isAuthenticated||n.path("/login"),t},response:function(e){return e}};return r}]),angular.module("MLEditor").factory("CommonService",["globalConstants","itPopup","$rootScope","$window","$location","$translate",function(e,t,n,r,a,i){function o(e,n,r){var a="";if(""==r||"info"==r)a=i.instant(e);else{var o="alert-popup-"+r;a='<span class="'+o+'"> '+i.instant(e)+"</span>"}t.alert({title:a,text:n})}function l(e,t){o(e,t,I)}function s(e,t){o(e,t,g)}function u(){return localStorage.getItem(p)}function d(){var e=u();if(null==e||""==e){var t=a.protocol()+"://"+a.host()+":"+a.port();c(t)}}function c(e){(null!=e||""!=e)&&localStorage.setItem(p,e)}function f(){n.$applyAsync(function(){var e=document.createEvent("Event");e.initEvent("resize",!0,!0),r.dispatchEvent(e)})}var m={showAlertPopup:o,showErrorAlertPopup:l,showSuccessAlertPopup:s,getRootUrl:u,initRootUrl:d,saveRootUrl:c,resizeEvent:f},p="doc_editor_root_url_key",I="error",g="success";return m}]),angular.module("MLEditor").factory("RequestService",["$http","$base64","globalConstants","$rootScope","$translate","CommonService",function(e,t,n,r,a,i){function o(t,n){return e({method:"GET",url:t,headers:u(r.basicAuthenticationValue),params:n})}function l(t,n,a){return e({method:"POST",url:t,data:n,headers:u(r.basicAuthenticationValue),params:a})}function s(e){return i.getRootUrl()+e}function u(e){var t={};return"undefined"!=typeof e&&""!=e&&(t.Authorization="Basic "+e),t.Pragma="no-cache",t["Cache-Control"]="no-cache, no-store, must-revalidate",t}function d(e){var t="";if(null==e.data){var n=a.instant("UNEXPECTED_SERVER_ERROR");t=a.instant("ERROR_CODE",e.status)+" </br>"+a.instant("ERROR_MESSAGE",n)+" </br>"}else{var r=f(e);if("undefined"!=typeof r&&""!=r&&null!=r){var i={value:m(e)},o={value:p(e)},l={value:I(e)},s={value:g(e)};t=a.instant("ERROR_CODE",i)+" </br>"+a.instant("ERROR_STATE",o)+" </br>"+a.instant("ERROR_MESSAGE_CODE",l)+" </br>"+a.instant("ERROR_MESSAGE",s)+" </br>"}else t=c(e)}return t}function c(e){return e.data}function f(e){return e.data.errorResponse}function m(e){return f(e).statusCode}function p(e){return f(e).status}function I(e){return f(e).messageCode}function g(e){return f(e).message}var E={doPost:l,doGet:o,buildServiceUrl:s,buildErrorResponseAlertText:d};return E}]),angular.module("MLEditor").factory("XmlService",["$rootScope",function(e){function t(t){var n=new DOMParser,r=null;try{r=n.parseFromString(t,"text/xml"),e.currentXmlDom=r}catch(a){return console.error("Xml is not valid : ",a.message),!1}return!0}var n={validateXml:t};return e.currentXmlDom=null,n}]),angular.module("MLEditor").controller("MainController",["$scope","$translate",function(e,t){e.currentLanguage="fr_FR",e.editorOptions={lineWrapping:!0,lineNumbers:!0,indentWithTabs:!0,matchTags:{bothTags:!0},extraKeys:{"Ctrl-J":"toMatchingTag",F11:function(t){t.setOption("fullScreen",!t.getOption("fullScreen")),e.isFullScreen=!0},Esc:function(t){t.getOption("fullScreen")&&t.setOption("fullScreen",!1),e.isFullScreen=!1},"Ctrl-Q":function(e){e.foldCode(e.getCursor())}},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],styleActiveLine:!0,mode:"xml"},e.changeLanguage=function(n){e.currentLanguage=n,t.use(n)}}]),angular.module("MLEditor").controller("LoginController",["$base64","$scope","$rootScope","$location","CommonService","LoginService",function(e,t,n,r,a,i){function o(){return t.basicEncrypted=e.encode(t.account.user+":"+t.account.password),t.basicEncrypted}a.initRootUrl(),t.account={url:a.getRootUrl(),login:"",password:""},t.loginFailed=!1,t.login=function(){n.basicAuthenticationValue=o(),a.saveRootUrl(t.account.url),i.connect().then(function(e){t.status=e.status,n.isAuthenticated=!0,r.path("/invoices/search")},function(e){n.isAuthenticated=!1,t.loginFailed=!0})}}]),angular.module("MLEditor").controller("LogoutController",["LoginService",function(e){e.logout()}]),angular.module("MLEditor").factory("LoginService",["$rootScope","globalConstants","RequestService",function(e,t,n){function r(){var e=n.buildServiceUrl(t.LOGIN_PATH);return n.doGet(e,{})}function a(){e.basicAuthenticationValue=null,e.isAuthenticated=!1,e.loginFailed=!1}var i={connect:r,logout:a};return i}]),angular.module("MLEditor").controller("ConfigurationFilesController",["$rootScope","$scope","globalConstants","itPopup","CommonService","XmlService","ConfigurationFilesService","$translate",function(e,t,n,r,a,i,o,l){function s(e){var t=null;return null!=e&&(t=e.path),t}function u(){var e=t.masterDetails.getCurrentItemWrapper().originalItem;return s(e)}t.lastItemIdentifier=null,t.masterDetails={},t.files=[{name:"indicators.xml",path:"/db/models/indicators.xml"},{name:"flow-indicators.xml",path:"/db/models/flow-indicators.xml"}],t.masterDetails={columnDefs:[{field:"name",displayName:"CONFIGURATION.FILE.NAME",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"path",displayName:"CONFIGURATION.FILE.PATH",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1}]},t.masterDetails.disableMultiSelect=!0,t.masterDetails.navAlert={text:"{{'CANNOT_EDIT_INVOICE' | translate}}",title:"{{'WARNING' | translate}}"},t.deleteIsDisabled=function(){var e=!1;return 0==t.masterDetail.getSelectedItems().length&&(e=!0),e},t.$watch("masterDetails.getCurrentItemWrapper().originalItem",function(){if(t.itemIdentifier=null,null!=t.masterDetails.getCurrentItemWrapper()&&"undefined"!=typeof t.masterDetails.getCurrentItemWrapper()){var e=u();null!=e&&(t.itemIdentifier=e)}"undefined"!=typeof t.itemIdentifier&&null!=t.itemIdentifier&&t.itemIdentifier!==t.lastItemIdentifier&&o.get(t.itemIdentifier,"xml").then(function(e){t.loadXmlInCurrentItem(e),t.$applyAsync(function(){t.masterDetails.setCurrentItem(t.files[t.masterDetails.getCurrentItemWrapper().index])}),t.lastItemIdentifier=t.itemIdentifier},function(e){t.data=e.data||"Request failed",t.status=e.status})}),t.loadXmlInCurrentItem=function(e){var n={};angular.copy(t.files[t.masterDetails.getCurrentItemWrapper().index],n),n.xml=vkbeautify.xml(e.data),angular.copy(n,t.files[t.masterDetails.getCurrentItemWrapper().index])},t.getDetailMessage=function(){var e="";return t.masterDetails.initState&&(e=t.masterDetails.getSelectedItems().length>0?t.masterDetails.getSelectedItems().length+" items selected":l.instant("NO_ITEM_SELECTED")),e},t.reloadFiles=function(){t.search()},t.search=function(){o.search("json").then(function(e){"undefined"!=typeof e.data.files&&(t.files=e.data.files.file,a.resizeEvent())},function(e){t.data=e.data||"Request failed",t.status=e.status;var n=o.buildErrorResponseAlertText(e);a.showErrorAlertPopup("SAVE_FAILED",n)})},t.save=function(){var e=i.validateXml(t.masterDetails.getCurrentItemWrapper().currentItem.xml);return e?void o.save("CONF",t.masterDetails.getCurrentItemWrapper().currentItem.xml,t.itemIdentifier).then(function(e){angular.copy(t.masterDetails.getCurrentItemWrapper().currentItem,t.files[t.masterDetails.getCurrentItemWrapper().index]);var n=e.data;a.showSuccessAlertPopup("SAVE_RESULT",n),t.$broadcast("unlockCurrentItem")},function(e){t.data=e.data||"Request failed",t.status=e.status;var n=o.buildErrorResponseAlertText(e);a.showErrorAlertPopup("SAVE_FAILED",n)}):void a.showErrorAlertPopup("ERROR","{{'XML_NOT_VALID' | translate}}")},t.undoChange=function(){t.masterDetails.undoChangeCurrentItem(),t.disableSaveActions=!1},t.files=t.search()}]),angular.module("MLEditor").factory("ConfigurationFilesService",["globalConstants","RequestService",function(e,t){function n(n){var r=t.buildServiceUrl(e.CONFIGURATION_FILES.SEARCH.PATH),a=l(e.DATA_DATABASE_NAME,n);return t.doGet(r,a)}function r(n,r,a){var i=t.buildServiceUrl(e.CONFIGURATION_FILES.SAVE.PATH),l=o(n,a);return t.doPost(i,r,l)}function a(n,r){var a=t.buildServiceUrl(e.CONFIGURATION_FILES.GET.PATH),o=i(n,r);return t.doGet(a,o)}function i(e,t){var n={};return n.uri=s(e).uri,n.mode=u(t).mode,n}function o(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n.type=e),"undefined"!=typeof t&&""!=t&&(n.uri=t),n}function l(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n["db-name"]=e),n.mode=u(t).mode,n}function s(e){var t={};return t.uri="","undefined"!=typeof e&&""!=e&&(t.uri=e),t}function u(e){var t={};return t.mode="","undefined"!=typeof e&&""!=e&&(t.mode=e),t}function d(e){return t.buildErrorResponseAlertText(e)}var c={search:n,save:r,get:a,buildErrorResponseAlertText:d};return c}]),angular.module("MLEditor").controller("InvoiceQueuedController",["$rootScope","$scope","globalConstants","itPopup","CommonService","XmlService","InvoiceQueuedService","$translate",function(e,t,n,r,a,i,o,l){function s(e){var t=null;return null!=e&&null!=e.uri&&(t=e.uri),t}function u(){var e=t.masterDetails.getCurrentItemWrapper().originalItem;return s(e)}function d(){var t=null;if("undefined"!=typeof e.currentXmlDom&&null!=e.currentXmlDom){var n=e.currentXmlDom.getElementsByTagName("ItesoftId");if(null!=n&&"undefined"!=typeof n&&n.length>0)if(null!=n[0]&&"undefined"!=typeof n[0].innerHTML&&""!==n[0].innerHTML)t=n[0].innerHTML;else{var r=n[0].childNodes;r.length>0&&null!=r[0]&&"undefined"!=typeof r[0]?t=r[0].nodeValue:console.error("Itesoft id from xml is null or empty")}else console.error("Cannot find 'ItesoftId' element in invoice xml")}else console.error("$rootScope.currentXmlDom is undefined or null. So cannot retrieve 'ItesoftId' element in xml.");return t}function d(){var t=null;if("undefined"!=typeof e.currentXmlDom&&null!=e.currentXmlDom){var n=e.currentXmlDom.getElementsByTagName("ItesoftId");if(null!=n&&"undefined"!=typeof n&&n.length>0)if(null!=n[0]&&"undefined"!=typeof n[0].innerHTML&&""!==n[0].innerHTML)t=n[0].innerHTML;else{var r=n[0].childNodes;r.length>0&&null!=r[0]&&"undefined"!=typeof r[0]?t=r[0].nodeValue:console.error("Itesoft id from xml is null or empty")}else console.error("Cannot find 'ItesoftId' element in invoice xml")}else console.error("$rootScope.currentXmlDom is undefined or null. So cannot retrieve 'ItesoftId' element in xml.");return t}function c(e){var n={};n=e.data.queuedInvoice,t.$applyAsync(function(){n.xml=t.masterDetails.getCurrentItemWrapper().currentItem.xml,angular.copy(n,t.invoices[t.masterDetails.getCurrentItemWrapper().index])})}function f(e,n){angular.forEach(e,function(e){var r=n.indexOf(e);t.sendDeleteRequest(s(e),n,r)})}function m(e,t){e.splice(t,1)}t.lastItemIdentifier=null,t.masterDetails={},t.invoices=[],t.masterDetails={columnDefs:[{field:"range",displayName:"UPDATE_RANGE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"itesoftId",displayName:"ITESOFT_ID",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"businessGroup",displayName:"BUSINNESS_GROUP",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"batchName",displayName:"BATCH_NAME",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!1},{field:"scanDate",displayName:"SCAN_DATE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0}]},t.masterDetails.disableMultiSelect=!0,t.masterDetails.navAlert={text:"{{'CANNOT_EDIT_INVOICE' | translate}}",title:"{{'WARNING' | translate}}"},t.clearCriteria=function(){t.search.itesoftid="",t.search.batchname="",t.search.businessgroup="",t.search.state="",t.search.invoicenumber="",t.search.category="",t.search.startDate="",t.search.endDate=""},t.deleteIsDisabled=function(){var e=!1;return 0==t.masterDetail.getSelectedItems().length&&(e=!0),e},t.$watch("masterDetails.getCurrentItemWrapper().originalItem",function(){if(t.itemIdentifier=null,null!=t.masterDetails.getCurrentItemWrapper()&&"undefined"!=typeof t.masterDetails.getCurrentItemWrapper()){var e=u();null!=e&&(t.itemIdentifier=e)}"undefined"!=typeof t.itemIdentifier&&null!=t.itemIdentifier&&t.itemIdentifier!==t.lastItemIdentifier&&o.get(t.itemIdentifier,"xml").then(function(e){t.loadXmlInCurrentItem(e),t.$applyAsync(function(){t.masterDetails.setCurrentItem(t.invoices[t.masterDetails.getCurrentItemWrapper().index])}),t.lastItemIdentifier=t.itemIdentifier},function(e){t.data=e.data||"Request failed",t.status=e.status})}),t.loadXmlInCurrentItem=function(e){var n={};angular.copy(t.invoices[t.masterDetails.getCurrentItemWrapper().index],n),n.xml=vkbeautify.xml(e.data),angular.copy(n,t.invoices[t.masterDetails.getCurrentItemWrapper().index])},t.getDetailMessage=function(){var e="";return t.masterDetails.initState&&(e=t.masterDetails.getSelectedItems().length>0?t.masterDetails.getSelectedItems().length+" items selected":l.instant("NO_ITEM_SELECTED")),e},t.search=function(){t.invoices=[],o.search(t.search).then(function(e){t.status=e.status,"undefined"!=typeof e.data.result.queuedInvoice&&(t.invoices=e.data.result.queuedInvoice,t.total=e.data.result.total,t.pageStart=e.data.result.pageStart,t.pageNum=e.data.result.pageNum,a.resizeEvent())},function(e){t.data=e.data||"Request failed",t.status=e.status;var n=o.buildErrorResponseAlertText(e);a.showErrorAlertPopup("SEARCH_FAILED",n)})},t.showConfirmPopupDeleteItems=function(e,n){var a=r.confirm({title:e,text:n,buttons:[{text:"{{'CONFIRM_BUTTON' | translate}}",type:"btn-danger",onTap:function(){return!0}},{text:"{{'CANCEL_BUTTON' | translate}}",type:"btn-success",onTap:function(){return!1}}]});a.then(function(e){f(t.masterDetails.getSelectedItems(),t.invoices),t.masterDetails.setCurrentItem(null)},function(){})},t.save=function(){var e=i.validateXml(t.masterDetails.getCurrentItemWrapper().currentItem.xml);return e?(("undefined"==typeof t.itemIdentifier||null==t.itemIdentifier)&&(t.itemIdentifier=d(),console.log("$scope.itemIdentifier after set = ",t.itemIdentifier)),console.log("$scope.itemIdentifier = ",t.itemIdentifier),void o.save("QUEUE",t.masterDetails.getCurrentItemWrapper().currentItem.xml,t.itemIdentifier).then(function(e){angular.copy(t.masterDetails.getCurrentItemWrapper().currentItem,t.invoices[t.masterDetails.getCurrentItemWrapper().index]);var n=o.buildErrorResponseAlertText(e);a.showSuccessAlertPopup("SAVE_RESULT",n),o.getLight(t.itemIdentifier,"json").then(function(e){c(e)},function(e){t.data=e.data||"Request failed",t.status=e.status}),t.$broadcast("unlockCurrentItem")},function(e){t.data=e.data||"Request failed",t.status=e.status;var n=o.buildErrorResponseAlertText(e);a.showErrorAlertPopup("SAVE_FAILED",n)})):void a.showErrorAlertPopup("ERROR","{{'XML_NOT_VALID' | translate}}")},t.undoChange=function(){var e=!1,n=t.masterDetails.getCurrentItemWrapper();if(null!=n&&"undefined"!=typeof n){var r=n.originalItem;if(null==r||"undefined"==typeof r||null==r.xml||""==r.xml){var a=t.masterDetails.getCurrentItemWrapper().currentItem;if(null!=a&&(null==a.xml||""==a.xml)&&t.invoices.length>0){m(t.invoices,t.invoices.length-1);var e=!0}}}t.masterDetails.undoChangeCurrentItem(),e&&t.masterDetails.setCurrentItem(null),t.disableSaveActions=!1},t.addNewItem=function(){var e={xml:null};t.invoices.push(e),t.masterDetails.setCurrentItem(e).then(function(e){t.$broadcast("lockCurrentItem",!1)},function(e){})},t.deleteSelectedItems=function(){t.showConfirmPopupDeleteItems("{{'DELETE_POPUP_TITLE' | translate}}","{{'DELETE_POPUP_TEXT' | translate}}")},t.sendDeleteRequest=function(e,n,r){o["delete"](e).then(function(e){var i=o.buildErrorResponseAlertText(e);a.showSuccessAlertPopup("DELETE_RESULT",i),t.$broadcast("unlockCurrentItem"),m(n,r)},function(e){var t=o.buildErrorResponseAlertText(e);a.showErrorAlertPopup("DELETE_FAILED",t)})}}]),angular.module("MLEditor").factory("InvoiceQueuedService",["globalConstants","RequestService",function(e,t){function n(n){var r=t.buildServiceUrl(e.INVOICE_QUEUED.SEARCH.PATH),a=c(n);return t.doGet(r,a)}function r(n,r,a){var i=t.buildServiceUrl(e.INVOICE_QUEUED.SAVE.PATH),o=d(n,a);return t.doPost(i,r,o)}function a(n){var r=t.buildServiceUrl(e.INVOICE_QUEUED.DELETE.PATH),a=s(n);return t.doGet(r,a)}function i(n,r){var a=t.buildServiceUrl(e.INVOICE_QUEUED.GET.PATH),i=l(n,r);return t.doGet(a,i)}function o(n,r){var a=t.buildServiceUrl(e.INVOICE_QUEUED.GET_LIGHT.PATH),i=l(n,r);return t.doGet(a,i)}function l(e,t){var n={};return n.uri=s(e).uri,n.mode=u(t).mode,n}function s(e){var t={};return t.itesoftid="","undefined"!=typeof e&&""!=e&&(t.uri=e),t}function u(e){var t={};return t.mode="","undefined"!=typeof e&&""!=e&&(t.mode=e),t}function d(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n.type=e),"undefined"!=typeof t&&""!=t&&(n.uri=t),n}function c(t){var n={};return"undefined"!=typeof t.itesoftid&&""!=t.itesoftid&&(n.itesoftid=t.itesoftid),"undefined"!=typeof t.batchname&&""!=t.batchname&&(n.batchname=t.batchname),"undefined"!=typeof t.businessgroup&&""!=t.businessgroup&&(n.businessgroup=t.businessgroup),"undefined"!=typeof t.state&&""!=t.state&&(n.state=t.state),"undefined"!=typeof t.invoicenumber&&""!=t.invoicenumber&&(n.invoicenumber=t.invoicenumber),"undefined"!=typeof t.category&&""!=t.category&&(n.category=t.category),"undefined"!=typeof t.startDate&&""!=t.startDate&&(n.startDate=t.startDate),"undefined"!=typeof t.endDate&&""!=t.endDate&&(n.endDate=t.endDate),n.mode=t.mode,n.pageNum=e.INVOICE_QUEUED.SEARCH.RESULT_MAX_NUMBER,n}function f(e){return t.buildErrorResponseAlertText(e)}var m={search:n,save:r,get:i,getLight:o,"delete":a,buildErrorResponseAlertText:f};return m}]),angular.module("MLEditor").controller("InvoiceSearchController",["$rootScope","$scope","globalConstants","itPopup","InvoiceService","CommonService","XmlService","$translate",function(e,t,n,r,a,i,o,l){function s(e){var t=null;return null!=e&&null!=e.ItesoftData&&null!=e.ItesoftData.Document&&null!=e.ItesoftData.Document.Class&&null!=e.ItesoftData.Document.Class.ITESOFTFields&&null!=e.ItesoftData.Document.Class.ITESOFTFields.ItesoftId&&(t=e.ItesoftData.Document.Class.ITESOFTFields.ItesoftId),t}function u(){var e=t.masterDetails.getCurrentItemWrapper().originalItem;return s(e)}function d(){var t=null;if("undefined"!=typeof e.currentXmlDom&&null!=e.currentXmlDom){var n=e.currentXmlDom.getElementsByTagName("ItesoftId");if(null!=n&&"undefined"!=typeof n&&n.length>0)if(null!=n[0]&&"undefined"!=typeof n[0].innerHTML&&""!==n[0].innerHTML)t=n[0].innerHTML;else{var r=n[0].childNodes;r.length>0&&null!=r[0]&&"undefined"!=typeof r[0]?t=r[0].nodeValue:console.error("Itesoft id from xml is null or empty")}else console.error("Cannot find 'ItesoftId' element in invoice xml")}else console.error("$rootScope.currentXmlDom is undefined or null. So cannot retrieve 'ItesoftId' element in xml.");return t}function c(e){var n={};n=e.data,t.$applyAsync(function(){n.xml=t.masterDetails.getCurrentItemWrapper().currentItem.xml,angular.copy(n,t.invoices[t.masterDetails.getCurrentItemWrapper().index])})}function f(e,n){angular.forEach(e,function(e){var r=n.indexOf(e);t.sendDeleteRequest(s(e),n,r)})}function m(e,t){e.splice(t,1)}t.lastItesoftId=null,t.masterDetails={},t.invoices=[],t.masterDetails={columnDefs:[{field:"ItesoftData.Document.Class.ITESOFTFields.ItesoftId",displayName:"ITESOFT_ID",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"ItesoftData.Document.Class.ITESOFTFields.BusinessGroup",displayName:"BUSINNESS_GROUP",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0,enableGrouping:!1},{field:"ItesoftData.Document.Class.HeaderFields.BATCHNAME",displayName:"BATCH_NAME",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!1},{field:"ItesoftData.Document.Class.HeaderFields.STATE",displayName:"STATE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0},{field:"ItesoftData.Document.Class.HeaderFields.SCANDATE",displayName:"SCAN_DATE",headerCellFilter:"translate",enableSorting:!0,enableColumnMenu:!0}]},t.masterDetails.disableMultiSelect=!0,t.masterDetails.navAlert={text:"{{'CANNOT_EDIT_INVOICE' | translate}}",title:"{{'WARNING' | translate}}"},t.clearCriteria=function(){t.search.itesoftid="",t.search.batchname="",t.search.businessgroup="",t.search.state="",t.search.invoicenumber="",t.search.category="",t.search.startDate="",t.search.endDate=""},t.deleteIsDisabled=function(){var e=!1;return 0==t.masterDetail.getSelectedItems().length&&(e=!0),e},t.$watch("masterDetails.getCurrentItemWrapper().originalItem",function(){if(t.invoiceId=null,null!=t.masterDetails.getCurrentItemWrapper()&&"undefined"!=typeof t.masterDetails.getCurrentItemWrapper()){var e=u();null!=e&&(t.invoiceId=e)}"undefined"!=typeof t.invoiceId&&null!=t.invoiceId&&t.invoiceId!==t.lastItesoftId&&a.get(t.invoiceId,"xml").then(function(e){t.loadXmlInCurrentItem(e),t.$applyAsync(function(){t.masterDetails.setCurrentItem(t.invoices[t.masterDetails.getCurrentItemWrapper().index])}),t.lastItesoftId=t.invoiceId},function(e){t.data=e.data||"Request failed",t.status=e.status})}),t.loadXmlInCurrentItem=function(e){var n={};angular.copy(t.invoices[t.masterDetails.getCurrentItemWrapper().index],n),n.xml=vkbeautify.xml(e.data),angular.copy(n,t.invoices[t.masterDetails.getCurrentItemWrapper().index])},t.getDetailMessage=function(){var e="";return t.masterDetails.initState&&(e=t.masterDetails.getSelectedItems().length>0?t.masterDetails.getSelectedItems().length+" items selected":l.instant("NO_ITEM_SELECTED")),e},t.search=function(){t.invoices=[],a.search(t.search).then(function(e){t.status=e.status,"undefined"!=typeof e.data.invoice&&(t.invoices=e.data.invoice,i.resizeEvent())},function(e){t.data=e.data||"Request failed",t.status=e.status;var n=a.buildErrorResponseAlertText(e);i.showErrorAlertPopup("SEARCH_FAILED",n)})},t.showConfirmPopupDeleteItems=function(e,n){var a=r.confirm({title:e,text:n,buttons:[{text:"{{'CONFIRM_BUTTON' | translate}}",type:"btn-danger",onTap:function(){return!0}},{text:"{{'CANCEL_BUTTON' | translate}}",type:"btn-success",onTap:function(){return!1}}]});a.then(function(e){f(t.masterDetails.getSelectedItems(),t.invoices),t.masterDetails.setCurrentItem(null)},function(){})},t.save=function(){var e=o.validateXml(t.masterDetails.getCurrentItemWrapper().currentItem.xml);return e?void a.save("INVOICE",t.masterDetails.getCurrentItemWrapper().currentItem.xml,"/db/invoices/2002/01/01/TEST/INV_20020101_TEST.xml").then(function(e){angular.copy(t.masterDetails.getCurrentItemWrapper().currentItem,t.invoices[t.masterDetails.getCurrentItemWrapper().index]);var n=a.buildErrorResponseAlertText(e);i.showSuccessAlertPopup("SAVE_RESULT",n),t.invoiceId=d(),a.get(t.invoiceId,"json").then(function(e){c(e)},function(e){t.data=e.data||"Request failed",t.status=e.status}),t.$broadcast("unlockCurrentItem")},function(e){t.data=e.data||"Request failed",t.status=e.status;var n=a.buildErrorResponseAlertText(e);i.showErrorAlertPopup("SAVE_FAILED",n)}):void i.showErrorAlertPopup("ERROR","{{'XML_NOT_VALID' | translate}}")},t.undoChange=function(){var e=!1,n=t.masterDetails.getCurrentItemWrapper();if(null!=n&&"undefined"!=typeof n){var r=n.originalItem;if(null==r||"undefined"==typeof r||null==r.xml||""==r.xml){var a=t.masterDetails.getCurrentItemWrapper().currentItem;if(null!=a&&(null==a.xml||""==a.xml)&&t.invoices.length>0){m(t.invoices,t.invoices.length-1);var e=!0}}}t.masterDetails.undoChangeCurrentItem(),e&&t.masterDetails.setCurrentItem(null),t.disableSaveActions=!1},t.addNewItem=function(){var e={xml:null};t.invoices.push(e),t.masterDetails.setCurrentItem(e).then(function(e){t.$broadcast("lockCurrentItem",!1)},function(e){})},t.deleteSelectedItems=function(){t.showConfirmPopupDeleteItems("{{'DELETE_POPUP_TITLE' | translate}}","{{'DELETE_POPUP_TEXT' | translate}}")},t.sendDeleteRequest=function(e,n,r){a["delete"](e).then(function(e){var o=a.buildErrorResponseAlertText(e);i.showSuccessAlertPopup("DELETE_RESULT",o),t.$broadcast("unlockCurrentItem"),m(n,r)},function(e){var t=a.buildErrorResponseAlertText(e);i.showErrorAlertPopup("DELETE_FAILED",t)})}}]),angular.module("MLEditor").factory("InvoiceService",["globalConstants","RequestService",function(e,t){function n(n){var r=t.buildServiceUrl(e.INVOICE.SEARCH.PATH),a=d(n);return t.doGet(r,a)}function r(n,r,a){var i=t.buildServiceUrl(e.INVOICE.SAVE.PATH),o=u(n,a);return t.doPost(i,r,o)}function a(n){var r=t.buildServiceUrl(e.INVOICE.DELETE.PATH),a=l(n);return t.doGet(r,a)}function i(n,r){var a=t.buildServiceUrl(e.INVOICE.GET.PATH),i=o(n,r);return t.doGet(a,i)}function o(e,t){var n={};return n.itesoftid=l(e).itesoftid,n.mode=s(t).mode,n}function l(e){var t={};return t.itesoftid="","undefined"!=typeof e&&""!=e&&(t.itesoftid=e),t}function s(e){var t={};return t.mode="","undefined"!=typeof e&&""!=e&&(t.mode=e),t}function u(e,t){var n={};return"undefined"!=typeof e&&""!=e&&(n.type=e),"undefined"!=typeof t&&""!=t&&(n.uri=t),n}function d(t){var n={};return"undefined"!=typeof t.itesoftid&&""!=t.itesoftid&&(n.itesoftid=t.itesoftid),"undefined"!=typeof t.batchname&&""!=t.batchname&&(n.batchname=t.batchname),"undefined"!=typeof t.businessgroup&&""!=t.businessgroup&&(n.businessgroup=t.businessgroup),"undefined"!=typeof t.state&&""!=t.state&&(n.state=t.state),"undefined"!=typeof t.invoicenumber&&""!=t.invoicenumber&&(n.invoicenumber=t.invoicenumber),"undefined"!=typeof t.category&&""!=t.category&&(n.category=t.category),"undefined"!=typeof t.startDate&&""!=t.startDate&&(n.startDate=t.startDate),"undefined"!=typeof t.endDate&&""!=t.endDate&&(n.endDate=t.endDate),n.mode=t.mode,n.pageNum=e.INVOICE.SEARCH.RESULT_MAX_NUMBER,n}function c(e){return t.buildErrorResponseAlertText(e)}var f={search:n,save:r,get:i,"delete":a,buildErrorResponseAlertText:c};return f}])}();